<view class="container font-lvl-{{fontSizeLevel}} {{isDarkMode ? 'dark-mode' : ''}}">
  <!-- 头部卡片 -->
  <view class="header-card">
    
    <block wx:if="{{userInfo.isLoggedIn}}">
      <!-- [新增] 退出登录按钮 -->
      <view class="logout-btn" bindtap="handleLogout">退出</view>

      <!-- 已登录状态 -->
      <view class="user-info">
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view class="edit-badge">📷</view>
        </button>
        
        <view class="info-text">
          <view class="nickname-row" bindtap="onEditNickname">
             <view class="nickname">{{userInfo.nickname?userInfo.nickname:'请编辑昵称'}}</view>
             <view class="edit-icon">✎</view>
          </view>
          <view class="uid">ID: {{userInfo.UID}}</view>
        </view>
      </view>
    </block>

    <block wx:else>
      <!-- 未登录状态 -->
      <view class="login-wrapper" bindtap="handleLogin">
        <view class="avatar-placeholder">
           <text class="placeholder-icon">👤</text>
        </view>
        <view class="login-info">
          <text class="login-title">点击登录账户</text>
          <text class="login-desc">同步学习进度与收藏</text>
        </view>
        <view class="login-arrow">></view>
      </view>
    </block>
    
    <!-- 统计数据栏 -->
    <view class="stats-row">
      <view class="stat-item">
        <view class="num">{{!userInfo.isLoggedIn ? '/' : userInfo.points>10000 ?'无限' : userInfo.points }}</view>
        <view class="label">今日体验额度</view>
      </view>
      
      <view class="stat-item" bindtap="handleSignIn">
        <view class="num">{{userInfo.hasSignedIn ? '已签' : '签到'}}</view>
        <view class="label">每日+20</view>
      </view>

      <button class="stat-item share-btn" open-type="share" bindtap="handleShareTap">
        <view class="num text-orange">{{userInfo.hasSharedToday ? '已享' : '分享'}}</view>
        <view class="label">每日+50</view>
      </button>

      <!-- <view class="stat-item" bindtap="goPurchase">
        <view class="num text-yellow">💎</view>
        <view class="label">购买积分</view>
      </view> -->
      
      <view class="stat-item">
        <view class="num text-yellow">{{studyTimeDisplay}}</view>
        <view class="label">总学习时长</view>
      </view>

    </view>
  </view>

  <!-- 菜单列表 -->
  <view class="menu-list card">
    <view class="menu-title">功能设置</view>
    <view class="menu-item" bindtap="handleFontSize">
      <view class="menu-left">
        <view class="menu-icon purple">A</view>
        <text>字体大小</text>
      </view>
      <view class="menu-right">
        <text class="status-text">{{fontSizeLabel}}</text>
        <text class="arrow">></text>
      </view>
    </view>

    <view class="menu-item" bindtap="handleDarkMode">
      <view class="menu-left">
        <view class="menu-icon blue">🌙</view>
        <text>夜间模式</text>
      </view>
      <view class="menu-right">
        <view class="toggle-switch {{isDarkMode ? 'on' : 'off'}}">
          <view class="toggle-circle"></view>
        </view>
      </view>
    </view>

    <!-- [新增] 播放倍速设置 -->
    <picker 
      class="menu-item" 
      bindchange="bindPlayRateChange" 
      value="{{playRateIndex}}" 
      range="{{playRateOptions}}"
    >
      <view class="picker-inner">
        <view class="menu-left">
          <view class="menu-icon pink">⏩</view>
          <text>音频倍速播放</text>
        </view>
        <view class="menu-right">
          <text class="status-text">{{playRateOptions[playRateIndex]}}</text>
          <text class="arrow">></text>
        </view>
      </view>
    </picker>


    <!-- [新增] 发音音色设置 -->
    <picker 
      class="menu-item" 
      bindchange="bindVoiceChange" 
      value="{{voiceIndex}}" 
      range="{{voiceOptions}}"
    >
      <view class="picker-inner">
        <view class="menu-left">
          <view class="menu-icon indigo">🗣️</view>
          <text>不同口音切换</text>
        </view>
        <view class="menu-right">
          <text class="status-text">{{voiceOptions[voiceIndex]}}</text>
          <text class="arrow">></text>
        </view>
      </view>
    </picker>

    <!-- <view class="menu-item" bindtap="navigateToMistake">
      <view class="menu-left">
        <view class="menu-icon purple">📓</view>
        <text>我的错题本</text>
      </view>
      <view class="menu-right">
        <text class="status-text">{{fontSizeLabel}}</text>
        <text class="arrow">></text>
      </view>
    </view> -->

    <!-- <view class="menu-item" bindtap="handleFontSize">
      <view class="menu-left">
        <view class="menu-icon purple">🧹</view>
        <text>清除已做题</text>
      </view>
      <view class="menu-right">
        <text class="status-text">{{fontSizeLabel}}</text>
        <text class="arrow">></text>
      </view>
    </view> -->

    <!-- <view class="menu-item" bindtap="handleDarkMode">
      <view class="menu-left">
        <view class="menu-icon blue">🔁</view>
        <text>语音循环播放</text>
      </view>
      <view class="menu-right">
        <view class="toggle-switch {{isDarkMode ? 'on' : 'off'}}">
          <view class="toggle-circle"></view>
        </view>
      </view>
    </view> -->

    <view class="menu-item" bindtap="SetFlipautoPlayfayin">
      <view class="menu-left">
        <view class="menu-icon blue">🔊</view>
        <text>卡片翻转自动发音</text>
      </view>
      <view class="menu-right">
        <view class="toggle-switch {{FlipautoPlayfayin ? 'on' : 'off'}}">
          <view class="toggle-circle"></view>
        </view>
      </view>
    </view>

    <view class="menu-item" bindtap="SetNextautoPlayfayin">
      <view class="menu-left">
        <view class="menu-icon blue">🔊</view>
        <text>滑下一题自动发音</text>
      </view>
      <view class="menu-right">
        <view class="toggle-switch {{NextautoPlayfayin ? 'on' : 'off'}}">
          <view class="toggle-circle"></view>
        </view>
      </view>
    </view>

    <!-- [修改] 每组题数设置 - 改为 Picker 选择器 -->
    <picker class="picker-full-width" bindchange="bindQuizCountChange" value="{{quizCountIndex}}" range="{{quizOptions}}" range-key="">
      <view class="menu-item">
        <view class="menu-left">
          <view class="menu-icon cyan">🔢</view>
          <text>做题练习每组题数</text>
        </view>
        <view class="menu-right">
          <!-- 显示当前选中的值 -->
          <text class="status-text">{{quizOptions[quizCountIndex]}}</text>
          <text class="arrow">></text>
        </view>
      </view>
    </picker>

    <view class="menu-title margintop30">其他相关</view>
    
    <view class="menu-item" bindtap="navigateToContribute" wx:if="{{userInfo.isRecorder}}">
      <view class="menu-left">
        <view class="menu-icon red">🎙️</view>
        <text>录音贡献</text>
      </view>
      <text class="arrow">></text>
    </view>

    <!-- <view class="menu-item" bindtap="notImplemented">
      <view class="menu-left">
        <view class="menu-icon green">📝</view>
        <text>补充词条</text>
      </view>
      <text class="arrow">></text>
    </view> -->

    <!-- <view class="menu-item" bindtap="navigateToShare">
      <view class="menu-left">
        <view class="menu-icon green">🖼️</view>
        <text>宣传海报</text>
      </view>
      <text class="arrow">></text>
    </view> -->

    <view class="menu-item" bindtap="navigateToPrivacy">
      <view class="menu-left">
        <view class="menu-icon gray">🔒</view>
        <text>隐私协议</text>
      </view>
      <text class="arrow">></text>
    </view>

    <view class="menu-item" bindtap="navigateToAbout">
      <view class="menu-left">
        <view class="menu-icon orange">ℹ️</view>
        <text>关于软件</text>
      </view>
      <text class="arrow">></text>
    </view>

    <!-- [新增] 联系在线客服 -->
    <button class="menu-item contact-btn" open-type="contact">
      <view class="menu-left">
        <view class="menu-icon teal">🎧</view>
        <text>在线客服</text>
      </view>
      <text class="arrow">></text>
    </button>
    
    <!-- [修改] 绑定新的弹窗方法 -->
    <!-- <view class="menu-item" bindtap="showFeedback">
      <view class="menu-left">
        <view class="menu-icon green">💬</view>
        <text>意见反馈</text>
      </view>
      <text class="arrow">></text>
    </view> -->

  </view>
  
  <!-- <view class="footer">Version 1.0.0</view> -->

  <!-- [新增] 意见反馈弹窗 -->
  <view class="modal-mask" wx:if="{{showFeedbackModal}}" bindtap="hideFeedback">
    <view class="modal-container" catchtap="return">
      <view class="modal-title">意见反馈</view>
      <textarea 
        class="feedback-input" 
        placeholder="请输入您的宝贵建议，帮助我们做得更好..." 
        placeholder-class="input-placeholder"
        bindinput="onFeedbackInput"
        value="{{feedbackContent}}"
        maxlength="200"
        disable-default-padding="true"
      ></textarea>
      <view class="char-count">{{feedbackLen}}/200</view>
      <view class="modal-btns">
        <view class="btn-cancel" bindtap="hideFeedback">取消</view>
        <view class="btn-submit" bindtap="submitFeedback">提交</view>
      </view>
    </view>
  </view>

  <welcome-modal></welcome-modal>

</view>